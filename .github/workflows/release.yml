name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: core

      - name: Build
        run: |
          # Rust core (universal binary)
          cd core
          cargo build --release --target aarch64-apple-darwin
          cargo build --release --target x86_64-apple-darwin
          lipo -create \
            target/aarch64-apple-darwin/release/libgonhanh_core.a \
            target/x86_64-apple-darwin/release/libgonhanh_core.a \
            -output ../platforms/macos/libgonhanh_core.a

          # macOS app
          cd ../platforms/macos
          xcodebuild -scheme GoNhanh -configuration Release \
            -derivedDataPath build CODE_SIGN_IDENTITY="-"

      - name: Package
        run: |
          cd platforms/macos
          V="${GITHUB_REF_NAME#v}"
          APP="build/Build/Products/Release/GoNhanh.app"

          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $V" "$APP/Contents/Info.plist"
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $V" "$APP/Contents/Info.plist"

          # Create beautiful DMG with custom layout
          ../../scripts/create-dmg.sh "$APP"

      - name: Get tag message
        id: tag_message
        run: |
          # Fetch tag with annotation
          git fetch origin tag ${{ github.ref_name }} --force

          # Get message from annotated tag
          TAG_MSG=$(git for-each-ref --format='%(contents)' refs/tags/${{ github.ref_name }})

          # Debug
          echo "=== Tag message ==="
          echo "$TAG_MSG"
          echo "==================="

          # Output for next step
          {
            echo "message<<EOF"
            echo "$TAG_MSG"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: platforms/macos/build/*.dmg
          body: ${{ steps.tag_message.outputs.message }}
          generate_release_notes: ${{ steps.tag_message.outputs.message == '' }}

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: core

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            fcitx5 \
            libfcitx5core-dev \
            libfcitx5config-dev \
            libfcitx5utils-dev \
            fcitx5-modules-dev \
            extra-cmake-modules \
            libxkbcommon-dev \
            cmake \
            pkg-config

      - name: Build
        run: |
          # Rust core
          cd core
          cargo build --release

          # Fcitx5 addon
          cd ../platforms/linux
          mkdir -p build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc)

      - name: Package
        run: |
          PKG="gonhanh-linux"
          mkdir -p "$PKG/lib" "$PKG/share/fcitx5/addon" "$PKG/share/fcitx5/inputmethod"

          cp platforms/linux/build/gonhanh.so "$PKG/lib/"
          cp core/target/release/libgonhanh_core.so "$PKG/lib/"
          cp platforms/linux/data/gonhanh-addon.conf "$PKG/share/fcitx5/addon/gonhanh.conf"
          cp platforms/linux/data/gonhanh.conf "$PKG/share/fcitx5/inputmethod/"
          cp platforms/linux/README.md "$PKG/"
          cp platforms/linux/scripts/install.sh "$PKG/"
          chmod +x "$PKG/install.sh"

          tar -czvf "$PKG.tar.gz" "$PKG"

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-tarball
          path: "*.tar.gz"

      - name: Add to Release
        uses: softprops/action-gh-release@v2
        with:
          files: "*.tar.gz"

  update-homebrew:
    needs: build-macos
    runs-on: ubuntu-latest
    steps:
      - name: Download DMG and get SHA256
        id: sha
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          curl -L -o GoNhanh.dmg "https://github.com/khaphanspace/gonhanh.org/releases/download/${{ github.ref_name }}/GoNhanh.dmg"
          SHA256=$(shasum -a 256 GoNhanh.dmg | awk '{print $1}')
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update Homebrew Cask
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          VERSION: ${{ steps.sha.outputs.version }}
          SHA256: ${{ steps.sha.outputs.sha256 }}
        run: |
          git clone https://x-access-token:${GH_TOKEN}@github.com/khaphanspace/homebrew-gonhanh.git
          cd homebrew-gonhanh

          cat > Casks/gonhanh.rb << CASKEOF
cask "gonhanh" do
  version "${VERSION}"
  sha256 "${SHA256}"

  url "https://github.com/khaphanspace/gonhanh.org/releases/download/v#{version}/GoNhanh.dmg"
  name "G천 Nhanh"
  desc "High-performance Vietnamese Input Method Engine for macOS"
  homepage "https://github.com/khaphanspace/gonhanh.org"

  livecheck do
    url :url
    strategy :github_latest
  end

  app "G천 Nhanh.app"

  postflight do
    system_command "/usr/bin/xattr",
                   args: ["-cr", "#{appdir}/G천 Nhanh.app"],
                   sudo: false
  end

  zap trash: [
    "~/Library/Preferences/space.khaphan.gonhanh.plist",
    "~/Library/Application Support/G천 Nhanh",
  ]
end
CASKEOF

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/gonhanh.rb
          git commit -m "Update gonhanh to ${VERSION}"
          git push

  build-windows:
    if: false
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: core

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Build Rust Core
        run: |
          cd core
          cargo build --release --target x86_64-pc-windows-msvc
          Copy-Item "target/x86_64-pc-windows-msvc/release/gonhanh_core.dll" `
                    "../platforms/windows/GoNhanh/Native/gonhanh_core.dll"

      - name: Build WPF App
        run: |
          cd platforms/windows/GoNhanh
          dotnet publish -c Release -r win-x64 --self-contained false -o ../publish

      - name: Package
        run: |
          cd platforms/windows
          $V = "${{ github.ref_name }}".TrimStart('v')
          Compress-Archive -Path publish/* -DestinationPath "GoNhanh-$V-win-x64.zip"

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-zip
          path: platforms/windows/*.zip
